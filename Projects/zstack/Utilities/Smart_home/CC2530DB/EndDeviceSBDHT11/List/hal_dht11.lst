###############################################################################
#                                                                             #
# IAR C/C++ Compiler V8.10.1.10194/W32 for 8051         25/Mar/2021  11:18:55 #
# Copyright 2004-2011 IAR Systems AB.                                         #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data_rom                                           #
#    Dptr setup         =  1,16                                               #
#    Source file        =  D:\毕设\CC2530-smart_home\Components\hal\target\CC #
#                          2530SB\hal_dht11.c                                 #
#    Command line       =  -f D:\毕设\CC2530-smart_home\Projects\zstack\Utili #
#                          ties\Smart_home\CC2530DB\..\..\..\Tools\CC2530DB\f #
#                          8wEndev.cfg (-DCPU32MHZ -DROOT=__near_func         #
#                          -DMAC_CFG_TX_DATA_MAX=3 -DMAC_CFG_TX_MAX=6         #
#                          -DMAC_CFG_RX_MAX=3) -f D:\毕设\CC2530-smart_home\P #
#                          rojects\zstack\Utilities\Smart_home\CC2530DB\..\.. #
#                          \..\Tools\CC2530DB\f8wConfig.cfg (-DZIGBEEPRO      #
#                          -DSECURE=0 -DZG_SECURE_DYNAMIC=0 -DREFLECTOR       #
#                          -DDEFAULT_CHANLIST=0x02000000                      #
#                          -DZDAPP_CONFIG_PAN_ID=0x1001                       #
#                          -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MA #
#                          SK=0x007F -DBEACON_REQUEST_DELAY=100               #
#                          -DBEACON_REQ_DELAY_MASK=0x00FF                     #
#                          -DLINK_STATUS_JITTER_MASK=0x007F                   #
#                          -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_PO #
#                          LLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7             #
#                          -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3    #
#                          -DNWK_MAX_DATA_RETRIES=2                           #
#                          -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9         #
#                          -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40           #
#                          -DNWK_MAX_BINDING_ENTRIES=4                        #
#                          -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,  #
#                          0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00,    #
#                          0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"         #
#                          -DMAC_MAX_FRAME_SIZE=116                           #
#                          -DZDNWKMGR_MIN_TRANSMISSIONS=20 "-DCONST=const     #
#                          __code" -DGENERIC=__generic                        #
#                          -DRFD_RCVC_ALWAYS_ON=FALSE -DPOLL_RATE=1000        #
#                          -DQUEUED_POLL_RATE=100 -DRESPONSE_POLL_RATE=100)   #
#                          -DREJOIN_POLL_RATE=440 D:\毕设\CC2530-smart_home\C #
#                          omponents\hal\target\CC2530SB\hal_dht11.c -D       #
#                          HAL_UART=TRUE -D HAL_UART_TEST -D xPOWER_SAVING    #
#                          -lC D:\毕设\CC2530-smart_home\Projects\zstack\Util #
#                          ities\Smart_home\CC2530DB\EndDeviceSBDHT11\List\   #
#                          -lA D:\毕设\CC2530-smart_home\Projects\zstack\Util #
#                          ities\Smart_home\CC2530DB\EndDeviceSBDHT11\List\   #
#                          --diag_suppress Pe001,Pa010 -o                     #
#                          D:\毕设\CC2530-smart_home\Projects\zstack\Utilitie #
#                          s\Smart_home\CC2530DB\EndDeviceSBDHT11\Obj\ -e     #
#                          --no_cse --no_unroll --no_inline --no_code_motion  #
#                          --no_tbaa --debug --core=plain --dptr=16,1         #
#                          --data_model=large --code_model=banked             #
#                          --calling_convention=xdata_reentrant               #
#                          --place_constants=data_rom --nr_virtual_regs 16    #
#                          -I D:\毕设\CC2530-smart_home\Projects\zstack\Utili #
#                          ties\Smart_home\CC2530DB\ -I                       #
#                          D:\毕设\CC2530-smart_home\Projects\zstack\Utilitie #
#                          s\Smart_home\CC2530DB\..\Source\ -I                #
#                          D:\毕设\CC2530-smart_home\Projects\zstack\Utilitie #
#                          s\Smart_home\CC2530DB\..\..\..\ZMain\TI2530DB\ -I  #
#                          D:\毕设\CC2530-smart_home\Projects\zstack\Utilitie #
#                          s\Smart_home\CC2530DB\..\..\..\..\..\Components\ha #
#                          l\include\ -I D:\毕设\CC2530-smart_home\Projects\z #
#                          stack\Utilities\Smart_home\CC2530DB\..\..\..\..\.. #
#                          \Components\hal\target\CC2530SB\ -I                #
#                          D:\毕设\CC2530-smart_home\Projects\zstack\Utilitie #
#                          s\Smart_home\CC2530DB\..\..\..\..\..\Components\ma #
#                          c\include\ -I D:\毕设\CC2530-smart_home\Projects\z #
#                          stack\Utilities\Smart_home\CC2530DB\..\..\..\..\.. #
#                          \Components\mac\high_level\ -I                     #
#                          D:\毕设\CC2530-smart_home\Projects\zstack\Utilitie #
#                          s\Smart_home\CC2530DB\..\..\..\..\..\Components\ma #
#                          c\low_level\srf04\ -I D:\毕设\CC2530-smart_home\Pr #
#                          ojects\zstack\Utilities\Smart_home\CC2530DB\..\..\ #
#                          ..\..\..\Components\mac\low_level\srf04\single_chi #
#                          p\ -I D:\毕设\CC2530-smart_home\Projects\zstack\Ut #
#                          ilities\Smart_home\CC2530DB\..\..\..\..\..\Compone #
#                          nts\mt\ -I D:\毕设\CC2530-smart_home\Projects\zsta #
#                          ck\Utilities\Smart_home\CC2530DB\..\..\..\..\..\Co #
#                          mponents\osal\include\ -I                          #
#                          D:\毕设\CC2530-smart_home\Projects\zstack\Utilitie #
#                          s\Smart_home\CC2530DB\..\..\..\..\..\Components\se #
#                          rvices\saddr\ -I D:\毕设\CC2530-smart_home\Project #
#                          s\zstack\Utilities\Smart_home\CC2530DB\..\..\..\.. #
#                          \..\Components\services\sdata\ -I                  #
#                          D:\毕设\CC2530-smart_home\Projects\zstack\Utilitie #
#                          s\Smart_home\CC2530DB\..\..\..\..\..\Components\st #
#                          ack\af\ -I D:\毕设\CC2530-smart_home\Projects\zsta #
#                          ck\Utilities\Smart_home\CC2530DB\..\..\..\..\..\Co #
#                          mponents\stack\nwk\ -I D:\毕设\CC2530-smart_home\P #
#                          rojects\zstack\Utilities\Smart_home\CC2530DB\..\.. #
#                          \..\..\..\Components\stack\sapi\ -I                #
#                          D:\毕设\CC2530-smart_home\Projects\zstack\Utilitie #
#                          s\Smart_home\CC2530DB\..\..\..\..\..\Components\st #
#                          ack\sec\ -I D:\毕设\CC2530-smart_home\Projects\zst #
#                          ack\Utilities\Smart_home\CC2530DB\..\..\..\..\..\C #
#                          omponents\stack\sys\ -I D:\毕设\CC2530-smart_home\ #
#                          Projects\zstack\Utilities\Smart_home\CC2530DB\..\. #
#                          .\..\..\..\Components\stack\zdo\ -I                #
#                          D:\毕设\CC2530-smart_home\Projects\zstack\Utilitie #
#                          s\Smart_home\CC2530DB\..\..\..\..\..\Components\zm #
#                          ac\ -I D:\毕设\CC2530-smart_home\Projects\zstack\U #
#                          tilities\Smart_home\CC2530DB\..\..\..\..\..\Compon #
#                          ents\zmac\f8w\ -On                                 #
#    List file          =  D:\毕设\CC2530-smart_home\Projects\zstack\Utilitie #
#                          s\Smart_home\CC2530DB\EndDeviceSBDHT11\List\hal_dh #
#                          t11.lst                                            #
#    Object file        =  D:\毕设\CC2530-smart_home\Projects\zstack\Utilitie #
#                          s\Smart_home\CC2530DB\EndDeviceSBDHT11\Obj\hal_dht #
#                          11.r51                                             #
#                                                                             #
#                                                                             #
###############################################################################

D:\毕设\CC2530-smart_home\Components\hal\target\CC2530SB\hal_dht11.c
      1          /*****************************************************************************
      2          *
      3          * 文 件 名：hal_dht11.c
      4          
      5          * 作    者: 南京安宸博研电子科技有限公司
      6          
      7          * 创建时间: 2019.04.01
      8          
      9          * 修改时间: 2019.04.21
     10          
     11          * IAR 版本: IAR for 8051 V8.10.1
     12          
     13          * 测试平台: Sensor MotherBoard V2.3
     14          
     15          * 说    明: 1. 实现DHT11温湿度传感器的数据读取, 驱动将来搬迁到Zstack协议栈.
     16          *           2. 如果测试出现问题(如全0), 请调整函数DHT11_ReadData(void)的判1区间.
     17          *           3. 根据手册, 每次读出的温湿度数值是上一次测量的结果, 欲获取实时数据,
     18          *              需连续读取两次, 但不建议连续多次读取传感器, 每次读取传感器间隔
     19          *              大于5秒即可获得准确的数据.
     20          *           4. 湿度范围: 20%~90%; 温度范围: 0~50C.
     21          *           5. 传感器采集到的数据只有整数部分, 暂时没有小数部分(留着扩展).
     22          *           6. 数据一共5个字节: 第一个为湿度整数, 第二个为湿度小数, 第三个为温度
     23          *              整数, 第四个为温度小数,第五个校验字节(校验值为前四个字节的和).
     24          *                               
     25          *****************************************************************************/
     26          
     27          // 头文件
     28          #include <ioCC2530.h>

   \                                 In  segment SFR_AN, at 0x90
   \   union <unnamed> volatile __sfr _A_P1
   \                     _A_P1:
   \   000000                DS 1

   \                                 In  segment SFR_AN, at 0xa8
   \   union <unnamed> volatile __sfr _A_IEN0
   \                     _A_IEN0:
   \   000000                DS 1

   \                                 In  segment SFR_AN, at 0xfe
   \   unsigned char volatile __sfr P1DIR
   \                     P1DIR:
   \   000000                DS 1
     29          #include "hal_mcu.h"
     30          
     31          // 引脚宏定义, 输入/输出是针对MCU而言
     32          #define SET_DHT11_PIN_OUTPUT    (P1DIR |= 0x02)
     33          #define SET_DHT11_PIN_HIGH      (P1_1   = 1)
     34          #define SET_DHT11_PIN_LOW       (P1_1   = 0)
     35          #define SET_DHT11_PIN_INPUT     (P1DIR &= ~0x02)
     36          #define GET_DHT11_PIN_DATA      (P1_1) 
     37          
     38          // 参数宏定义
     39          #define TIMEOUT_LIMIT 100       // 脉冲等待时限1000ms
     40          
     41          /*****************************************************************************
     42           * @fn          DHT11_Delay100us
     43           *
     44           * @brief       裸机条件下、时钟频率为32MHz时延时100微秒左右(不精确).
     45           *
     46           * @param       none
     47           *
     48           * @return      none
     49           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
     50          void DHT11_Delay100us(void)
   \                     DHT11_Delay100us:
     51          {
   \   000000                ; Saved register size: 0
   \   000000                ; Auto size: 0
     52              unsigned char cnt = 85;
   \   000000   7855         MOV     R0,#0x55
     53              while (cnt--)
   \                     ??DHT11_Delay100us_0:
   \   000002   E8           MOV     A,R0
   \   000003   F9           MOV     R1,A
   \   000004   74FF         MOV     A,#-0x1
   \   000006   29           ADD     A,R1
   \   000007   F8           MOV     R0,A
   \   000008   E9           MOV     A,R1
   \   000009   6005         JZ      ??DHT11_Delay100us_1
     54              {
     55                  asm("NOP");  
   \   00000B   00           NOP
     56                  asm("NOP");
   \   00000C   00           NOP
     57                  asm("NOP");
   \   00000D   00           NOP
   \   00000E   80F2         SJMP    ??DHT11_Delay100us_0
     58              }
     59          }
   \                     ??DHT11_Delay100us_1:
   \   000010   02....       LJMP    ?BRET
     60          
     61          /*****************************************************************************
     62           * @fn          DHT11_Delay10us
     63           *
     64           * @brief       裸机条件下、时钟频率为32MHz时延时10微秒左右(不精确).
     65           *
     66           * @param       none
     67           *
     68           * @return      none
     69           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
     70          void DHT11_Delay10us(void)
   \                     DHT11_Delay10us:
     71          {
   \   000000                ; Saved register size: 0
   \   000000                ; Auto size: 0
     72              unsigned char cnt = 9;
   \   000000   7809         MOV     R0,#0x9
     73              while (cnt--)
   \                     ??DHT11_Delay10us_0:
   \   000002   E8           MOV     A,R0
   \   000003   F9           MOV     R1,A
   \   000004   74FF         MOV     A,#-0x1
   \   000006   29           ADD     A,R1
   \   000007   F8           MOV     R0,A
   \   000008   E9           MOV     A,R1
   \   000009   6005         JZ      ??DHT11_Delay10us_1
     74              {
     75                  asm("NOP");  
   \   00000B   00           NOP
     76                  asm("NOP");
   \   00000C   00           NOP
     77                  asm("NOP");
   \   00000D   00           NOP
   \   00000E   80F2         SJMP    ??DHT11_Delay10us_0
     78              }
     79          }
   \                     ??DHT11_Delay10us_1:
   \   000010   02....       LJMP    ?BRET
     80          
     81          /*****************************************************************************
     82           * @fn          DHT11_Start
     83           *
     84           * @brief       启动DHT11
     85           *
     86           * @param       none
     87           *
     88           * @return      none
     89           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
     90          void DHT11_Start(void)
   \                     DHT11_Start:
     91          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
     92              unsigned char timeCnt;
     93              
     94              SET_DHT11_PIN_OUTPUT;   // 设置引脚为输出
   \   000005   43FE02       ORL     0xfe,#0x2
     95              SET_DHT11_PIN_LOW;      // 输出低电平, 启动总线
   \   000008   C291         CLR     0x90.1
     96              // 低电平保持时间不能小于18ms, 否则DHT11无法启动
     97              for(timeCnt=0; timeCnt<200; timeCnt++)
   \   00000A   7E00         MOV     R6,#0x0
   \                     ??DHT11_Start_0:
   \   00000C   EE           MOV     A,R6
   \   00000D   C3           CLR     C
   \   00000E   94C8         SUBB    A,#-0x38
   \   000010   5006         JNC     ??DHT11_Start_1
     98              {
     99                  DHT11_Delay100us();
   \   000012                ; Setup parameters for call to function DHT11_Delay100us
   \   000012   12....       LCALL   ??DHT11_Delay100us?relay
    100              }
   \   000015   0E           INC     R6
   \   000016   80F4         SJMP    ??DHT11_Start_0
    101              
    102              SET_DHT11_PIN_HIGH;     // 输出高电平
   \                     ??DHT11_Start_1:
   \   000018   D291         SETB    0x90.1
    103              SET_DHT11_PIN_INPUT;    // 设置为输入引脚(因有上拉电阻, 所以保持为高电平)    
   \   00001A   53FEFD       ANL     0xfe,#0xfd
    104          
    105              // 高电平持续20~40us
    106              for (timeCnt = 0; timeCnt < TIMEOUT_LIMIT; timeCnt++)
   \   00001D   7E00         MOV     R6,#0x0
   \                     ??DHT11_Start_2:
   \   00001F   EE           MOV     A,R6
   \   000020   C3           CLR     C
   \   000021   9464         SUBB    A,#0x64
   \   000023   500A         JNC     ??DHT11_Start_3
    107              {
    108                  if (!GET_DHT11_PIN_DATA)
   \   000025   A291         MOV     C,0x90.1
   \   000027   5006         JNC     ??DHT11_Start_3
    109                  {
    110                      break;  // 低电平退出循环
    111                  }
    112                  DHT11_Delay10us();
   \   000029                ; Setup parameters for call to function DHT11_Delay10us
   \   000029   12....       LCALL   ??DHT11_Delay10us?relay
    113              }
   \   00002C   0E           INC     R6
   \   00002D   80F0         SJMP    ??DHT11_Start_2
    114              // 超时返回
    115              if (timeCnt == TIMEOUT_LIMIT)
   \                     ??DHT11_Start_3:
   \   00002F   7464         MOV     A,#0x64
   \   000031   6E           XRL     A,R6
   \   000032   602C         JZ      ??DHT11_Start_4
    116              {
    117                  return;
    118              }
    119              // DHT11输出80微秒的低电平作为应答信号
    120              for (timeCnt = 0; timeCnt < TIMEOUT_LIMIT; timeCnt++)
   \   000034   7E00         MOV     R6,#0x0
   \                     ??DHT11_Start_5:
   \   000036   EE           MOV     A,R6
   \   000037   C3           CLR     C
   \   000038   9464         SUBB    A,#0x64
   \   00003A   500A         JNC     ??DHT11_Start_6
    121              {
    122                  if (GET_DHT11_PIN_DATA)
   \   00003C   A291         MOV     C,0x90.1
   \   00003E   4006         JC      ??DHT11_Start_6
    123                  {
    124                      break;  // 高电平退出循环
    125                  }
    126                  DHT11_Delay10us();
   \   000040                ; Setup parameters for call to function DHT11_Delay10us
   \   000040   12....       LCALL   ??DHT11_Delay10us?relay
    127              }
   \   000043   0E           INC     R6
   \   000044   80F0         SJMP    ??DHT11_Start_5
    128              // 超时返回
    129              if (timeCnt == TIMEOUT_LIMIT)
   \                     ??DHT11_Start_6:
   \   000046   7464         MOV     A,#0x64
   \   000048   6E           XRL     A,R6
   \   000049   6015         JZ      ??DHT11_Start_4
    130              {
    131                  return;
    132              }
    133              // DHT11紧接着输出80微秒的高电平通知外设准备接收数据
    134              for (timeCnt = 0; timeCnt < TIMEOUT_LIMIT; timeCnt++)
   \   00004B   7E00         MOV     R6,#0x0
   \                     ??DHT11_Start_7:
   \   00004D   EE           MOV     A,R6
   \   00004E   C3           CLR     C
   \   00004F   9464         SUBB    A,#0x64
   \   000051   500A         JNC     ??DHT11_Start_8
    135              {
    136                  if (!GET_DHT11_PIN_DATA)    // 低电平退出循环
   \   000053   A291         MOV     C,0x90.1
   \   000055   5006         JNC     ??DHT11_Start_8
    137                  {
    138                      break;
    139                  }
    140                  DHT11_Delay10us();
   \   000057                ; Setup parameters for call to function DHT11_Delay10us
   \   000057   12....       LCALL   ??DHT11_Delay10us?relay
    141              }
   \   00005A   0E           INC     R6
   \   00005B   80F0         SJMP    ??DHT11_Start_7
    142              // 超时返回
    143              if (timeCnt == TIMEOUT_LIMIT)
   \                     ??DHT11_Start_8:
   \   00005D   7464         MOV     A,#0x64
   \   00005F   6E           XRL     A,R6
    144              {
    145                  return;
    146              }
    147          }
   \                     ??DHT11_Start_4:
   \   000060   7F01         MOV     R7,#0x1
   \   000062   02....       LJMP    ?BANKED_LEAVE_XDATA
   \   000065                REQUIRE P1DIR
   \   000065                REQUIRE _A_P1
    148          
    149          /*****************************************************************************
    150           * @fn          DHT11_ReadData
    151           *
    152           * @brief       从DHT11读取一个字节数据
    153           *
    154           * @param       none
    155           *
    156           * @return      读取的数据, 返回0则表示超时报错.
    157           *              位数据"0"的格式为50微秒的低电平和26-28微秒的高电平，
    158           *              位数据"1"的格式为50微秒的低电平和70微秒的高电平.	
    159           * 
    160           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    161          unsigned char DHT11_ReadData(void)
   \                     DHT11_ReadData:
    162          {
   \   000000   74F6         MOV     A,#-0xa
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 0
    163              unsigned char bitCnt, timeCnt;
    164              unsigned char byteVal = 0;
   \   000005   7E00         MOV     R6,#0x0
    165              halIntState_t intState;
    166              
    167              for (bitCnt = 0; bitCnt < 8; bitCnt++)
   \   000007   75..00       MOV     ?V0 + 0,#0x0
   \                     ??DHT11_ReadData_0:
   \   00000A   E5..         MOV     A,?V0 + 0
   \   00000C   C3           CLR     C
   \   00000D   9408         SUBB    A,#0x8
   \   00000F   5057         JNC     ??DHT11_ReadData_1
    168              {
    169                  // DHT11输出50us低电平, 提醒主机数据位已开始传送
    170                  for (timeCnt = 0; timeCnt < TIMEOUT_LIMIT; timeCnt++)
   \   000011   7F00         MOV     R7,#0x0
   \                     ??DHT11_ReadData_2:
   \   000013   EF           MOV     A,R7
   \   000014   C3           CLR     C
   \   000015   9464         SUBB    A,#0x64
   \   000017   500A         JNC     ??DHT11_ReadData_3
    171                  {
    172                      if (GET_DHT11_PIN_DATA)    // 高电平退出循环
   \   000019   A291         MOV     C,0x90.1
   \   00001B   4006         JC      ??DHT11_ReadData_3
    173                      {
    174                          break;
    175                      }
    176                      DHT11_Delay10us();
   \   00001D                ; Setup parameters for call to function DHT11_Delay10us
   \   00001D   12....       LCALL   ??DHT11_Delay10us?relay
    177                  }        
   \   000020   0F           INC     R7
   \   000021   80F0         SJMP    ??DHT11_ReadData_2
    178                  if (timeCnt == TIMEOUT_LIMIT)   // 超时报错, 返回0
   \                     ??DHT11_ReadData_3:
   \   000023   7464         MOV     A,#0x64
   \   000025   6F           XRL     A,R7
   \   000026   7004         JNZ     ??DHT11_ReadData_4
    179                  {
    180                      return 0;
   \   000028   7900         MOV     R1,#0x0
   \   00002A   803E         SJMP    ??DHT11_ReadData_5
    181                  }
    182                  
    183                  HAL_ENTER_CRITICAL_SECTION(intState);
   \                     ??DHT11_ReadData_4:
   \   00002C   A2AF         MOV     C,0xa8.7
   \   00002E   E4           CLR     A
   \   00002F   33           RLC     A
   \   000030   F5..         MOV     ?V0 + 1,A
   \   000032   C2AF         CLR     0xa8.7
    184                  // DHT11输出高电平或低电平                   
    185                  for (timeCnt = 0; timeCnt < TIMEOUT_LIMIT; timeCnt++)
   \   000034   7F00         MOV     R7,#0x0
   \                     ??DHT11_ReadData_6:
   \   000036   EF           MOV     A,R7
   \   000037   C3           CLR     C
   \   000038   9464         SUBB    A,#0x64
   \   00003A   500A         JNC     ??DHT11_ReadData_7
    186                  {
    187                      if (!GET_DHT11_PIN_DATA)    // 低电平退出循环
   \   00003C   A291         MOV     C,0x90.1
   \   00003E   5006         JNC     ??DHT11_ReadData_7
    188                      {
    189                          break;
    190                      }
    191                      DHT11_Delay10us();
   \   000040                ; Setup parameters for call to function DHT11_Delay10us
   \   000040   12....       LCALL   ??DHT11_Delay10us?relay
    192                  }
   \   000043   0F           INC     R7
   \   000044   80F0         SJMP    ??DHT11_ReadData_6
    193                  if (timeCnt == TIMEOUT_LIMIT)   // 超时报错, 返回0
   \                     ??DHT11_ReadData_7:
   \   000046   7464         MOV     A,#0x64
   \   000048   6F           XRL     A,R7
   \   000049   7004         JNZ     ??DHT11_ReadData_8
    194                  {
    195                      return 0;
   \   00004B   7900         MOV     R1,#0x0
   \   00004D   801B         SJMP    ??DHT11_ReadData_5
    196                  }
    197                  HAL_EXIT_CRITICAL_SECTION(intState);
   \                     ??DHT11_ReadData_8:
   \   00004F   E5..         MOV     A,?V0 + 1
   \   000051   A2E0         MOV     C,0xE0 /* A   */.0
   \   000053   92AF         MOV     0xa8.7,C
    198                  
    199                  // 存储数据位, DHT11是先发高位
    200                  byteVal <<= 1;
   \   000055   EE           MOV     A,R6
   \   000056   C3           CLR     C
   \   000057   33           RLC     A
   \   000058   FE           MOV     R6,A
    201                  // 根据高电平的宽度判断是0还是1
    202                  if (timeCnt > 4) 
   \   000059   EF           MOV     A,R7
   \   00005A   C3           CLR     C
   \   00005B   9405         SUBB    A,#0x5
   \   00005D   4005         JC      ??DHT11_ReadData_9
    203                  {
    204                      byteVal |=  0x01;
   \   00005F   D3           SETB    C
   \   000060   EE           MOV     A,R6
   \   000061   92E0         MOV     0xE0 /* A   */.0,C
   \   000063   FE           MOV     R6,A
    205                  }
    206                  else 
    207                  {
    208                      byteVal |= 0x00;
    209                  }
    210              }
   \                     ??DHT11_ReadData_9:
   \   000064   05..         INC     ?V0 + 0
   \   000066   80A2         SJMP    ??DHT11_ReadData_0
    211              return byteVal;
   \                     ??DHT11_ReadData_1:
   \   000068   EE           MOV     A,R6
   \   000069   F9           MOV     R1,A
   \                     ??DHT11_ReadData_5:
   \   00006A   7F02         MOV     R7,#0x2
   \   00006C   02....       LJMP    ?BANKED_LEAVE_XDATA
   \   00006F                REQUIRE _A_P1
   \   00006F                REQUIRE _A_IEN0
    212          }
    213          
    214          /*****************************************************************************
    215           * @fn          HalDht11_Convert
    216           *
    217           * @brief       启动DHT11, 并完成一次转换.
    218           *
    219           * @param       none
    220           *
    221           * @return      转换值存在conversionVal数组中, 如果出错则不更新数据. 
    222           *              出错时, 可按以下几步进行检查:
    223           *              1. 检查延时函数的是否准确;
    224           *              2. 检查DHT11是否启动;
    225           *              3. 检查判别"0"与"1"的阈值是否合理;
    226           *              4. 检查校验码是否正确.
    227           * 
    228           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    229          void HalDht11_Convert(unsigned char conversionVal[4])
   \                     HalDht11_Convert:
    230          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 5
   \   000005   74FB         MOV     A,#-0x5
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   EA           MOV     A,R2
   \   00000B   FE           MOV     R6,A
   \   00000C   EB           MOV     A,R3
   \   00000D   FF           MOV     R7,A
    231              unsigned char checkSum;
    232              unsigned char tempData[5];
    233              
    234              DHT11_Start();      // 启动DHT11
   \   00000E                ; Setup parameters for call to function DHT11_Start
   \   00000E   12....       LCALL   ??DHT11_Start?relay
    235              
    236              // 读取数据
    237              tempData[0] = DHT11_ReadData();
   \   000011                ; Setup parameters for call to function DHT11_ReadData
   \   000011   12....       LCALL   ??DHT11_ReadData?relay
   \   000014   E9           MOV     A,R1
   \   000015   85..82       MOV     DPL,?XSP + 0
   \   000018   85..83       MOV     DPH,?XSP + 1
   \   00001B   F0           MOVX    @DPTR,A
    238              tempData[1] = DHT11_ReadData();
   \   00001C                ; Setup parameters for call to function DHT11_ReadData
   \   00001C   12....       LCALL   ??DHT11_ReadData?relay
   \   00001F   E9           MOV     A,R1
   \   000020   C0E0         PUSH    A
   \   000022   7401         MOV     A,#0x1
   \   000024   12....       LCALL   ?XSTACK_DISP0_8
   \   000027   D0E0         POP     A
   \   000029   F0           MOVX    @DPTR,A
    239              tempData[2] = DHT11_ReadData();
   \   00002A                ; Setup parameters for call to function DHT11_ReadData
   \   00002A   12....       LCALL   ??DHT11_ReadData?relay
   \   00002D   E9           MOV     A,R1
   \   00002E   C0E0         PUSH    A
   \   000030   7402         MOV     A,#0x2
   \   000032   12....       LCALL   ?XSTACK_DISP0_8
   \   000035   D0E0         POP     A
   \   000037   F0           MOVX    @DPTR,A
    240              tempData[3] = DHT11_ReadData();
   \   000038                ; Setup parameters for call to function DHT11_ReadData
   \   000038   12....       LCALL   ??DHT11_ReadData?relay
   \   00003B   E9           MOV     A,R1
   \   00003C   C0E0         PUSH    A
   \   00003E   7403         MOV     A,#0x3
   \   000040   12....       LCALL   ?XSTACK_DISP0_8
   \   000043   D0E0         POP     A
   \   000045   F0           MOVX    @DPTR,A
    241              tempData[4] = DHT11_ReadData();
   \   000046                ; Setup parameters for call to function DHT11_ReadData
   \   000046   12....       LCALL   ??DHT11_ReadData?relay
   \   000049   E9           MOV     A,R1
   \   00004A   C0E0         PUSH    A
   \   00004C   7404         MOV     A,#0x4
   \   00004E   12....       LCALL   ?XSTACK_DISP0_8
   \   000051   D0E0         POP     A
   \   000053   F0           MOVX    @DPTR,A
    242              
    243              // 计算校验值
    244              checkSum = (tempData[0] + tempData[1] + tempData[2] + tempData[3]);
   \   000054   7403         MOV     A,#0x3
   \   000056   12....       LCALL   ?XSTACK_DISP0_8
   \   000059   C082         PUSH    DPL
   \   00005B   C083         PUSH    DPH
   \   00005D   7402         MOV     A,#0x2
   \   00005F   12....       LCALL   ?XSTACK_DISP0_8
   \   000062   C082         PUSH    DPL
   \   000064   C083         PUSH    DPH
   \   000066   7401         MOV     A,#0x1
   \   000068   12....       LCALL   ?XSTACK_DISP0_8
   \   00006B   C082         PUSH    DPL
   \   00006D   C083         PUSH    DPH
   \   00006F   85..82       MOV     DPL,?XSP + 0
   \   000072   85..83       MOV     DPH,?XSP + 1
   \   000075   E0           MOVX    A,@DPTR
   \   000076   D083         POP     DPH
   \   000078   D082         POP     DPL
   \   00007A   F8           MOV     R0,A
   \   00007B   E0           MOVX    A,@DPTR
   \   00007C   28           ADD     A,R0
   \   00007D   D083         POP     DPH
   \   00007F   D082         POP     DPL
   \   000081   F8           MOV     R0,A
   \   000082   E0           MOVX    A,@DPTR
   \   000083   28           ADD     A,R0
   \   000084   D083         POP     DPH
   \   000086   D082         POP     DPL
   \   000088   F8           MOV     R0,A
   \   000089   E0           MOVX    A,@DPTR
   \   00008A   28           ADD     A,R0
   \   00008B   F5..         MOV     ?V0 + 0,A
    245              
    246              // 验证校验值, 出错则不更新数据
    247              if (tempData[4] == checkSum)
   \   00008D   7404         MOV     A,#0x4
   \   00008F   12....       LCALL   ?XSTACK_DISP0_8
   \   000092   E0           MOVX    A,@DPTR
   \   000093   65..         XRL     A,?V0 + 0
   \   000095   7033         JNZ     ??HalDht11_Convert_0
    248              {
    249                  conversionVal[0] = tempData[0];
   \   000097   85..82       MOV     DPL,?XSP + 0
   \   00009A   85..83       MOV     DPH,?XSP + 1
   \   00009D   E0           MOVX    A,@DPTR
   \   00009E   8E82         MOV     DPL,R6
   \   0000A0   8F83         MOV     DPH,R7
   \   0000A2   F0           MOVX    @DPTR,A
    250                  conversionVal[1] = tempData[1];
   \   0000A3   7401         MOV     A,#0x1
   \   0000A5   12....       LCALL   ?XSTACK_DISP0_8
   \   0000A8   E0           MOVX    A,@DPTR
   \   0000A9   8E82         MOV     DPL,R6
   \   0000AB   8F83         MOV     DPH,R7
   \   0000AD   A3           INC     DPTR
   \   0000AE   F0           MOVX    @DPTR,A
    251                  conversionVal[2] = tempData[2];
   \   0000AF   7402         MOV     A,#0x2
   \   0000B1   12....       LCALL   ?XSTACK_DISP0_8
   \   0000B4   E0           MOVX    A,@DPTR
   \   0000B5   8E82         MOV     DPL,R6
   \   0000B7   8F83         MOV     DPH,R7
   \   0000B9   A3           INC     DPTR
   \   0000BA   A3           INC     DPTR
   \   0000BB   F0           MOVX    @DPTR,A
    252                  conversionVal[3] = tempData[3];
   \   0000BC   7403         MOV     A,#0x3
   \   0000BE   12....       LCALL   ?XSTACK_DISP0_8
   \   0000C1   E0           MOVX    A,@DPTR
   \   0000C2   8E82         MOV     DPL,R6
   \   0000C4   8F83         MOV     DPH,R7
   \   0000C6   A3           INC     DPTR
   \   0000C7   A3           INC     DPTR
   \   0000C8   A3           INC     DPTR
   \   0000C9   F0           MOVX    @DPTR,A
    253              }
    254              
    255              SET_DHT11_PIN_OUTPUT;   // 设置DHT11的控制引脚为输出引脚
   \                     ??HalDht11_Convert_0:
   \   0000CA   43FE02       ORL     0xfe,#0x2
    256              SET_DHT11_PIN_HIGH;     // 置高电平, 使DHT11处于低功耗待机模式
   \   0000CD   D291         SETB    0x90.1
    257          }
   \   0000CF   7405         MOV     A,#0x5
   \   0000D1   12....       LCALL   ?DEALLOC_XSTACK8
   \   0000D4   7F01         MOV     R7,#0x1
   \   0000D6   02....       LJMP    ?BANKED_LEAVE_XDATA
   \   0000D9                REQUIRE P1DIR
   \   0000D9                REQUIRE _A_P1

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??DHT11_Delay100us?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    DHT11_Delay100us

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??DHT11_Delay10us?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    DHT11_Delay10us

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??DHT11_Start?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    DHT11_Start

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??DHT11_ReadData?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    DHT11_ReadData

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??HalDht11_Convert?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    HalDht11_Convert

   Maximum stack usage in bytes:

     Function              ISTACK PSTACK XSTACK
     --------              ------ ------ ------
     DHT11_Delay100us          0      0      9
     DHT11_Delay10us           0      0     10
     DHT11_ReadData            0      0     24
       -> DHT11_Delay10us      0      0     20
       -> DHT11_Delay10us      0      0     20
     DHT11_Start               0      0     23
       -> DHT11_Delay100us     0      0     18
       -> DHT11_Delay10us      0      0     18
       -> DHT11_Delay10us      0      0     18
       -> DHT11_Delay10us      0      0     18
     HalDht11_Convert          6      0     14
       -> DHT11_Start          0      0     28
       -> DHT11_ReadData       0      0     28
       -> DHT11_ReadData       0      0     28
       -> DHT11_ReadData       0      0     28
       -> DHT11_ReadData       0      0     28
       -> DHT11_ReadData       0      0     28


   Segment part sizes:

     Function/Label           Bytes
     --------------           -----
     _A_P1                       1
     _A_IEN0                     1
     P1DIR                       1
     DHT11_Delay100us           19
     DHT11_Delay10us            19
     DHT11_Start               101
     DHT11_ReadData            111
     HalDht11_Convert          217
     ??DHT11_Delay100us?relay    6
     ??DHT11_Delay10us?relay     6
     ??DHT11_Start?relay         6
     ??DHT11_ReadData?relay      6
     ??HalDht11_Convert?relay    6

 
 467 bytes in segment BANKED_CODE
  30 bytes in segment BANK_RELAYS
   3 bytes in segment SFR_AN
 
 497 bytes of CODE memory
   0 bytes of DATA memory (+ 3 bytes shared)

Errors: none
Warnings: none
