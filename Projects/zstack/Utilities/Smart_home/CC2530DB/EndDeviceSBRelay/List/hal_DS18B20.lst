###############################################################################
#                                                                             #
# IAR C/C++ Compiler V8.10.1.10194/W32 for 8051         03/Jun/2021  00:01:25 #
# Copyright 2004-2011 IAR Systems AB.                                         #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data_rom                                           #
#    Dptr setup         =  1,16                                               #
#    Source file        =  D:\毕设\CC2530-smart_home\Components\hal\target\CC #
#                          2530SB\hal_DS18B20.c                               #
#    Command line       =  -f D:\毕设\CC2530-smart_home\Projects\zstack\Utili #
#                          ties\Smart_home\CC2530DB\..\..\..\Tools\CC2530DB\f #
#                          8wEndev.cfg (-DCPU32MHZ -DROOT=__near_func         #
#                          -DMAC_CFG_TX_DATA_MAX=3 -DMAC_CFG_TX_MAX=6         #
#                          -DMAC_CFG_RX_MAX=3) -f D:\毕设\CC2530-smart_home\P #
#                          rojects\zstack\Utilities\Smart_home\CC2530DB\..\.. #
#                          \..\Tools\CC2530DB\f8wConfig.cfg (-DZIGBEEPRO      #
#                          -DSECURE=0 -DZG_SECURE_DYNAMIC=0 -DREFLECTOR       #
#                          -DDEFAULT_CHANLIST=0x02000000                      #
#                          -DZDAPP_CONFIG_PAN_ID=0x1003                       #
#                          -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MA #
#                          SK=0x007F -DBEACON_REQUEST_DELAY=100               #
#                          -DBEACON_REQ_DELAY_MASK=0x00FF                     #
#                          -DLINK_STATUS_JITTER_MASK=0x007F                   #
#                          -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_PO #
#                          LLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7             #
#                          -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3    #
#                          -DNWK_MAX_DATA_RETRIES=2                           #
#                          -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9         #
#                          -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40           #
#                          -DNWK_MAX_BINDING_ENTRIES=4                        #
#                          -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,  #
#                          0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00,    #
#                          0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"         #
#                          -DMAC_MAX_FRAME_SIZE=116                           #
#                          -DZDNWKMGR_MIN_TRANSMISSIONS=20 "-DCONST=const     #
#                          __code" -DGENERIC=__generic                        #
#                          -DRFD_RCVC_ALWAYS_ON=FALSE -DPOLL_RATE=1000        #
#                          -DQUEUED_POLL_RATE=100 -DRESPONSE_POLL_RATE=100)   #
#                          -DREJOIN_POLL_RATE=440 D:\毕设\CC2530-smart_home\C #
#                          omponents\hal\target\CC2530SB\hal_DS18B20.c -D     #
#                          HAL_UART=TRUE -D HAL_UART_TEST -D xPOWER_SAVING    #
#                          -lC D:\毕设\CC2530-smart_home\Projects\zstack\Util #
#                          ities\Smart_home\CC2530DB\EndDeviceSBRelay\List\   #
#                          -lA D:\毕设\CC2530-smart_home\Projects\zstack\Util #
#                          ities\Smart_home\CC2530DB\EndDeviceSBRelay\List\   #
#                          --diag_suppress Pe001,Pa010 -o                     #
#                          D:\毕设\CC2530-smart_home\Projects\zstack\Utilitie #
#                          s\Smart_home\CC2530DB\EndDeviceSBRelay\Obj\ -e     #
#                          --no_code_motion --debug --core=plain --dptr=16,1  #
#                          --data_model=large --code_model=banked             #
#                          --calling_convention=xdata_reentrant               #
#                          --place_constants=data_rom --nr_virtual_regs 16    #
#                          -I D:\毕设\CC2530-smart_home\Projects\zstack\Utili #
#                          ties\Smart_home\CC2530DB\ -I                       #
#                          D:\毕设\CC2530-smart_home\Projects\zstack\Utilitie #
#                          s\Smart_home\CC2530DB\..\Source\ -I                #
#                          D:\毕设\CC2530-smart_home\Projects\zstack\Utilitie #
#                          s\Smart_home\CC2530DB\..\..\..\ZMain\TI2530DB\ -I  #
#                          D:\毕设\CC2530-smart_home\Projects\zstack\Utilitie #
#                          s\Smart_home\CC2530DB\..\..\..\..\..\Components\ha #
#                          l\include\ -I D:\毕设\CC2530-smart_home\Projects\z #
#                          stack\Utilities\Smart_home\CC2530DB\..\..\..\..\.. #
#                          \Components\hal\target\CC2530SB\ -I                #
#                          D:\毕设\CC2530-smart_home\Projects\zstack\Utilitie #
#                          s\Smart_home\CC2530DB\..\..\..\..\..\Components\ma #
#                          c\include\ -I D:\毕设\CC2530-smart_home\Projects\z #
#                          stack\Utilities\Smart_home\CC2530DB\..\..\..\..\.. #
#                          \Components\mac\high_level\ -I                     #
#                          D:\毕设\CC2530-smart_home\Projects\zstack\Utilitie #
#                          s\Smart_home\CC2530DB\..\..\..\..\..\Components\ma #
#                          c\low_level\srf04\ -I D:\毕设\CC2530-smart_home\Pr #
#                          ojects\zstack\Utilities\Smart_home\CC2530DB\..\..\ #
#                          ..\..\..\Components\mac\low_level\srf04\single_chi #
#                          p\ -I D:\毕设\CC2530-smart_home\Projects\zstack\Ut #
#                          ilities\Smart_home\CC2530DB\..\..\..\..\..\Compone #
#                          nts\mt\ -I D:\毕设\CC2530-smart_home\Projects\zsta #
#                          ck\Utilities\Smart_home\CC2530DB\..\..\..\..\..\Co #
#                          mponents\osal\include\ -I                          #
#                          D:\毕设\CC2530-smart_home\Projects\zstack\Utilitie #
#                          s\Smart_home\CC2530DB\..\..\..\..\..\Components\se #
#                          rvices\saddr\ -I D:\毕设\CC2530-smart_home\Project #
#                          s\zstack\Utilities\Smart_home\CC2530DB\..\..\..\.. #
#                          \..\Components\services\sdata\ -I                  #
#                          D:\毕设\CC2530-smart_home\Projects\zstack\Utilitie #
#                          s\Smart_home\CC2530DB\..\..\..\..\..\Components\st #
#                          ack\af\ -I D:\毕设\CC2530-smart_home\Projects\zsta #
#                          ck\Utilities\Smart_home\CC2530DB\..\..\..\..\..\Co #
#                          mponents\stack\nwk\ -I D:\毕设\CC2530-smart_home\P #
#                          rojects\zstack\Utilities\Smart_home\CC2530DB\..\.. #
#                          \..\..\..\Components\stack\sapi\ -I                #
#                          D:\毕设\CC2530-smart_home\Projects\zstack\Utilitie #
#                          s\Smart_home\CC2530DB\..\..\..\..\..\Components\st #
#                          ack\sec\ -I D:\毕设\CC2530-smart_home\Projects\zst #
#                          ack\Utilities\Smart_home\CC2530DB\..\..\..\..\..\C #
#                          omponents\stack\sys\ -I D:\毕设\CC2530-smart_home\ #
#                          Projects\zstack\Utilities\Smart_home\CC2530DB\..\. #
#                          .\..\..\..\Components\stack\zdo\ -I                #
#                          D:\毕设\CC2530-smart_home\Projects\zstack\Utilitie #
#                          s\Smart_home\CC2530DB\..\..\..\..\..\Components\zm #
#                          ac\ -I D:\毕设\CC2530-smart_home\Projects\zstack\U #
#                          tilities\Smart_home\CC2530DB\..\..\..\..\..\Compon #
#                          ents\zmac\f8w\ -Ohz                                #
#    List file          =  D:\毕设\CC2530-smart_home\Projects\zstack\Utilitie #
#                          s\Smart_home\CC2530DB\EndDeviceSBRelay\List\hal_DS #
#                          18B20.lst                                          #
#    Object file        =  D:\毕设\CC2530-smart_home\Projects\zstack\Utilitie #
#                          s\Smart_home\CC2530DB\EndDeviceSBRelay\Obj\hal_DS1 #
#                          8B20.r51                                           #
#                                                                             #
#                                                                             #
###############################################################################

D:\毕设\CC2530-smart_home\Components\hal\target\CC2530SB\hal_DS18B20.c
      1          /*****************************************************************************
      2          *
      3          * 文 件 名：hal_ds18b20.c
      4          * 作    者: 柳成林
      5          * 创建时间: 2021.3.15
      6          * 修改时间: 2021.5.10
      7          * 说    明: 1. DS18B20单线总线通信, CC2530与此通过P1_1管脚进行通信.
      8          *           2. DS18B20空闲状态时, 总线为高电平.
      9          *           3. 拉低总线480us可以复位DS18B20.
     10          *              需连续读取两次, 但不建议连续多次读取传感器, 每次读取传感器间隔
     11          *              大于5秒即可获得准确的数据.
     12          *           4. 测量的温度数值12位精度: 后4位是小数, 前面的5位空, 中间的7位是
     13          *              整数部分.
     14          *                               
     15          *****************************************************************************/
     16          
     17          // 头文件
     18          #include <ioCC2530.h>

   \                                 In  segment SFR_AN, at 0x90
   \   union <unnamed> volatile __sfr _A_P1
   \                     _A_P1:
   \   000000                DS 1

   \                                 In  segment SFR_AN, at 0xa8
   \   union <unnamed> volatile __sfr _A_IEN0
   \                     _A_IEN0:
   \   000000                DS 1

   \                                 In  segment SFR_AN, at 0xfe
   \   unsigned char volatile __sfr P1DIR
   \                     P1DIR:
   \   000000                DS 1
     19          #include "hal_types.h"
     20          #include "hal_mcu.h"
     21          
     22          // 引脚宏定义, 输入/输出是针对MCU而言
     23          #define SET_DS18B20_PIN_HIGH    (P1_1 = 1)
     24          #define SET_DS18B20_PIN_LOW     (P1_1 = 0)
     25          #define SET_DS18B20_PIN_INPUT   (P1DIR &= ~0x02)
     26          #define SET_DS18B20_PIN_OUTPUT  (P1DIR |= 0x02)
     27          #define GET_DS18B20_PIN_DATA    (P1_1)
     28          
     29          
     30          // DS18B20相关命令
     31          #define CONVERT_T_CMD           0x44
     32          #define SKIP_ROM_CMD            0xCC
     33          #define READ_SCRATCHPAD_CMD     0xBE
     34          #define WRITE_SCRATCHPAD_CMD    0x4E
     35          
     36          /*****************************************************************************
     37           * @fn          HalDs18b20DelayNus
     38           *
     39           * @brief       裸机条件下、时钟频率为32MHz时实现N个微秒的延时(不精确).
     40           *
     41           * @param       n--延时长度
     42           *
     43           * @return      none
     44           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
     45          void HalDs18b20DelayNus(uint16 cnt)
   \                     HalDs18b20DelayNus:
     46          {
   \   000000                ; Saved register size: 0
   \   000000                ; Auto size: 0
   \   000000   8003         SJMP    ??HalDs18b20DelayNus_0
     47              while (cnt--)
     48              {
     49                  asm("NOP");  
   \                     ??HalDs18b20DelayNus_1:
   \   000002   00           NOP
     50                  asm("NOP");
   \   000003   00           NOP
     51                  asm("NOP");
   \   000004   00           NOP
     52              }
   \                     ??HalDs18b20DelayNus_0:
   \   000005   EA           MOV     A,R2
   \   000006   F8           MOV     R0,A
   \   000007   EB           MOV     A,R3
   \   000008   F9           MOV     R1,A
   \   000009   E8           MOV     A,R0
   \   00000A   24FF         ADD     A,#-0x1
   \   00000C   1A           DEC     R2
   \   00000D   E9           MOV     A,R1
   \   00000E   34FF         ADDC    A,#-0x1
   \   000010   FB           MOV     R3,A
   \   000011   E8           MOV     A,R0
   \   000012   49           ORL     A,R1
   \   000013   70ED         JNZ     ??HalDs18b20DelayNus_1
     53          }
   \   000015   02....       LJMP    ?BRET
     54          
     55          /*****************************************************************************
     56           * @fn          DS18B20_Init
     57           *
     58           * @brief       对DS18B20进行复位操作.
     59           *
     60           * @param       none
     61           *
     62           * @return      1--成功, 0--失败
     63           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
     64          uint8 DS18B20_Init(void)
   \                     DS18B20_Init:
     65          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
     66              uint8 opSts = 0;
     67              halIntState_t intState;
     68              
     69              SET_DS18B20_PIN_OUTPUT;
   \   000005   43FE02       ORL     0xfe,#0x2
     70              SET_DS18B20_PIN_LOW;
   \   000008   C291         CLR     0x90.1
     71              HalDs18b20DelayNus(750);    // 480us以上的低电平复位脉冲
   \   00000A                ; Setup parameters for call to function HalDs18b20DelayNus
   \   00000A   7AEE         MOV     R2,#-0x12
   \   00000C   7B02         MOV     R3,#0x2
   \   00000E   12....       LCALL   ?Subroutine2 & 0xFFFF
     72              
     73              SET_DS18B20_PIN_HIGH; 
     74              SET_DS18B20_PIN_INPUT;      // 高电平持续存在, 等待DS18B20拉低总线
     75              
     76              HAL_ENTER_CRITICAL_SECTION(intState);
   \                     ??CrossCallReturnLabel_2:
   \   000011   E5A8         MOV     A,0xa8
   \   000013   FE           MOV     R6,A
   \   000014   C2AF         CLR     0xa8.7
     77              HalDs18b20DelayNus(80);     // 等待80us
   \   000016                ; Setup parameters for call to function HalDs18b20DelayNus
   \   000016   7A50         MOV     R2,#0x50
   \   000018   7B00         MOV     R3,#0x0
   \   00001A   12....       LCALL   ??HalDs18b20DelayNus?relay
     78              if(GET_DS18B20_PIN_DATA)    // DS18B20发出60~240us的低电平存在脉冲  
   \   00001D   E590         MOV     A,0x90
   \   00001F   FF           MOV     R7,A
     79              {
     80                  opSts = 0;  // 初始化失败, 总线上没有设备
     81              }
     82              else
     83              {
     84                  opSts = 1;  // 初始化成功, 总线上有设备拉低总线
     85              }
     86              HAL_EXIT_CRITICAL_SECTION(intState);
   \   000020   EE           MOV     A,R6
   \   000021   A2E7         MOV     C,0xE0 /* A   */.7
   \   000023   92AF         MOV     0xa8.7,C
     87              
     88              // 释放总线   
     89              SET_DS18B20_PIN_OUTPUT;
   \   000025   43FE02       ORL     0xfe,#0x2
     90              SET_DS18B20_PIN_HIGH;
   \   000028   D291         SETB    0x90.1
     91              HalDs18b20DelayNus(500);
   \   00002A                ; Setup parameters for call to function HalDs18b20DelayNus
   \   00002A   7AF4         MOV     R2,#-0xc
   \   00002C   7B01         MOV     R3,#0x1
   \   00002E   12....       LCALL   ??HalDs18b20DelayNus?relay
     92              
     93              return(opSts);
   \   000031   EF           MOV     A,R7
   \   000032   A2E1         MOV     C,0xE0 /* A   */.1
   \   000034   B3           CPL     C
   \   000035   E4           CLR     A
   \   000036   33           RLC     A
   \   000037   80..         SJMP    ?Subroutine0
   \   000039                REQUIRE P1DIR
   \   000039                REQUIRE _A_P1
   \   000039                REQUIRE _A_IEN0
     94          }

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine0:
   \   000000   F9           MOV     R1,A
   \   000001                REQUIRE ??Subroutine3_0
   \   000001                ; // Fall through to label ??Subroutine3_0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine3_0:
   \   000000   7F01         MOV     R7,#0x1
   \   000002   02....       LJMP    ?BANKED_LEAVE_XDATA

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine2:
   \   000000   12....       LCALL   ??HalDs18b20DelayNus?relay
   \   000003   D291         SETB    0x90.1
   \   000005   53FEFD       ANL     0xfe,#0xfd
   \   000008   22           RET
     95          
     96          /*****************************************************************************
     97           * @fn          DS18B20_WriteCMD
     98           *
     99           * @brief       向DS18B20写入一个字节的数据, 低位先发送.
    100           *
    101           * @param       wdata--写入的数据
    102           *
    103           * @return      none
    104           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    105          void DS18B20_WriteCMD(uint8 wdata)
   \                     DS18B20_WriteCMD:
    106          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   \   000005   E9           MOV     A,R1
   \   000006   FF           MOV     R7,A
    107              uint8 i;
    108              halIntState_t intState;
    109              
    110              for (i = 0; i < 8; i++)
   \   000007   7E08         MOV     R6,#0x8
    111              {
    112                  HAL_ENTER_CRITICAL_SECTION(intState);
   \                     ??DS18B20_WriteCMD_0:
   \   000009   A2AF         MOV     C,0xa8.7
   \   00000B   E4           CLR     A
   \   00000C   33           RLC     A
   \   00000D   F5..         MOV     ?V0 + 0,A
   \   00000F   C2AF         CLR     0xa8.7
    113                  SET_DS18B20_PIN_LOW;
   \   000011   C291         CLR     0x90.1
    114                  HalDs18b20DelayNus(15);            
   \   000013                ; Setup parameters for call to function HalDs18b20DelayNus
   \   000013   7A0F         MOV     R2,#0xf
   \   000015   7B00         MOV     R3,#0x0
   \   000017   12....       LCALL   ??HalDs18b20DelayNus?relay
    115                  
    116                  if(wdata & 0x01)    
   \   00001A   EF           MOV     A,R7
   \   00001B   A2E0         MOV     C,0xE0 /* A   */.0
   \   00001D   5004         JNC     ??DS18B20_WriteCMD_1
    117                  {
    118                      SET_DS18B20_PIN_HIGH;
   \   00001F   D291         SETB    0x90.1
   \   000021   8002         SJMP    ??DS18B20_WriteCMD_2
    119                  }
    120                  else
    121                  {
    122                      SET_DS18B20_PIN_LOW;
   \                     ??DS18B20_WriteCMD_1:
   \   000023   C291         CLR     0x90.1
    123                  }
    124                  
    125                  wdata >>= 1;
   \                     ??DS18B20_WriteCMD_2:
   \   000025   C3           CLR     C
   \   000026   13           RRC     A
   \   000027   FF           MOV     R7,A
    126                  HalDs18b20DelayNus(30); // DS18B20采样时长15~45us
   \   000028                ; Setup parameters for call to function HalDs18b20DelayNus
   \   000028   12....       LCALL   ?Subroutine1 & 0xFFFF
    127                  HAL_EXIT_CRITICAL_SECTION(intState);
    128                  
    129                  // 释放总线
    130                  SET_DS18B20_PIN_HIGH;
   \                     ??CrossCallReturnLabel_0:
   \   00002B   D291         SETB    0x90.1
    131                  HalDs18b20DelayNus(10); // 总线恢复时间 
   \   00002D                ; Setup parameters for call to function HalDs18b20DelayNus
   \   00002D   7A0A         MOV     R2,#0xa
   \   00002F   7B00         MOV     R3,#0x0
   \   000031   12....       LCALL   ??HalDs18b20DelayNus?relay
    132              }
   \   000034   1E           DEC     R6
   \   000035   EE           MOV     A,R6
   \   000036   70D1         JNZ     ??DS18B20_WriteCMD_0
    133          }
   \   000038   80..         SJMP    ??Subroutine3_0
   \   00003A                REQUIRE _A_IEN0
   \   00003A                REQUIRE _A_P1

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine1:
   \   000000   7A1E         MOV     R2,#0x1e
   \   000002   7B00         MOV     R3,#0x0
   \   000004   12....       LCALL   ??HalDs18b20DelayNus?relay
   \   000007   E5..         MOV     A,?V0 + 0
   \   000009   A2E0         MOV     C,0xE0 /* A   */.0
   \   00000B   92AF         MOV     0xa8.7,C
   \   00000D   22           RET
    134          
    135          /*****************************************************************************
    136           * @fn          DS18B20_ReadByte
    137           *
    138           * @brief       从DS18B20读取一个字节的数据.
    139           *
    140           * @param       none
    141           *
    142           * @return      读出的一个字节数据
    143           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    144          uint8 DS18B20_ReadByte(void)
   \                     DS18B20_ReadByte:
    145          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
    146              uint8 bitCnt;
    147              halIntState_t intState;
    148              uint8 tmpData = 0;
   \   000005   7E00         MOV     R6,#0x0
    149              
    150              for (bitCnt = 0; bitCnt < 8; bitCnt++)
   \   000007   7F08         MOV     R7,#0x8
    151              {
    152                  HAL_ENTER_CRITICAL_SECTION(intState);
   \                     ??DS18B20_ReadByte_0:
   \   000009   A2AF         MOV     C,0xa8.7
   \   00000B   E4           CLR     A
   \   00000C   33           RLC     A
   \   00000D   F5..         MOV     ?V0 + 0,A
   \   00000F   C2AF         CLR     0xa8.7
    153                  tmpData >>= 1;
   \   000011   EE           MOV     A,R6
   \   000012   13           RRC     A
   \   000013   FE           MOV     R6,A
    154                  
    155                  // 准备读数据
    156                  SET_DS18B20_PIN_OUTPUT;
   \   000014   43FE02       ORL     0xfe,#0x2
    157                  SET_DS18B20_PIN_LOW;
   \   000017   C291         CLR     0x90.1
    158                  HalDs18b20DelayNus(2);  // 延时2us
   \   000019                ; Setup parameters for call to function HalDs18b20DelayNus
   \   000019   7A02         MOV     R2,#0x2
   \   00001B   7B00         MOV     R3,#0x0
   \   00001D   12....       LCALL   ?Subroutine2 & 0xFFFF
    159                  // 等待设备响应
    160                  SET_DS18B20_PIN_HIGH;
    161                  SET_DS18B20_PIN_INPUT;
    162                  HalDs18b20DelayNus(15); // 主机延时15us后采样数据
   \                     ??CrossCallReturnLabel_3:
   \   000020                ; Setup parameters for call to function HalDs18b20DelayNus
   \   000020   7A0F         MOV     R2,#0xf
   \   000022   7B00         MOV     R3,#0x0
   \   000024   12....       LCALL   ??HalDs18b20DelayNus?relay
    163                  if (GET_DS18B20_PIN_DATA)   
   \   000027   A291         MOV     C,0x90.1
   \   000029   5004         JNC     ??DS18B20_ReadByte_1
    164                  {
    165                      tmpData |= 0x80;
   \   00002B   EE           MOV     A,R6
   \   00002C   D2E7         SETB    0xE0 /* A   */.7
   \   00002E   FE           MOV     R6,A
    166                  }
    167                  HalDs18b20DelayNus(30); // 等待从机发送数据结束
   \                     ??DS18B20_ReadByte_1:
   \   00002F                ; Setup parameters for call to function HalDs18b20DelayNus
   \   00002F   12....       LCALL   ?Subroutine1 & 0xFFFF
    168                  HAL_EXIT_CRITICAL_SECTION(intState);
    169                  
    170                  // 设置引脚为输出, 然后释放总线
    171                  SET_DS18B20_PIN_OUTPUT;
   \                     ??CrossCallReturnLabel_1:
   \   000032   43FE02       ORL     0xfe,#0x2
    172                  SET_DS18B20_PIN_HIGH;
   \   000035   D291         SETB    0x90.1
    173                  HalDs18b20DelayNus(10); // 总线恢复时间           
   \   000037                ; Setup parameters for call to function HalDs18b20DelayNus
   \   000037   7A0A         MOV     R2,#0xa
   \   000039   7B00         MOV     R3,#0x0
   \   00003B   12....       LCALL   ??HalDs18b20DelayNus?relay
    174              }
   \   00003E   1F           DEC     R7
   \   00003F   EF           MOV     A,R7
   \   000040   70C7         JNZ     ??DS18B20_ReadByte_0
    175          
    176              return  tmpData;
   \   000042   EE           MOV     A,R6
   \   000043   80..         SJMP    ?Subroutine0
   \   000045                REQUIRE _A_IEN0
   \   000045                REQUIRE P1DIR
   \   000045                REQUIRE _A_P1
    177          }
    178          
    179          /*****************************************************************************
    180           * @fn          DS18B20_ReadTemp
    181           *
    182           * @brief       从DS18B20的ScratchPad读取温度转换结果.
    183           *
    184           * @param       none
    185           *
    186           * @return      读取的温度数值
    187           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    188          uint16 DS18B20_ReadTemp(void)
   \                     DS18B20_ReadTemp:
    189          {
   \   000000   74F6         MOV     A,#-0xa
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 0
    190              uint8   tmpLowByte;
    191              uint16  tmpData;
    192              
    193              tmpLowByte  = DS18B20_ReadByte();           // 读低字节
   \   000005                ; Setup parameters for call to function DS18B20_ReadByte
   \   000005   12....       LCALL   ??DS18B20_ReadByte?relay
   \   000008   E9           MOV     A,R1
   \   000009   F5..         MOV     ?V0 + 0,A
    194              tmpData     = DS18B20_ReadByte() & 0x00FF;  // 读高字节
    195              tmpData     = ((tmpData << 8) | tmpLowByte);
    196              
    197              return  tmpData;
   \   00000B                ; Setup parameters for call to function DS18B20_ReadByte
   \   00000B   12....       LCALL   ??DS18B20_ReadByte?relay
   \   00000E   AA..         MOV     R2,?V0 + 0
   \   000010   E9           MOV     A,R1
   \   000011   FB           MOV     R3,A
   \   000012   7F02         MOV     R7,#0x2
   \   000014   02....       LJMP    ?BANKED_LEAVE_XDATA
    198          }
    199          
    200          /*****************************************************************************
    201           * @fn          DS18B20_ConvertTemp
    202           *
    203           * @brief       控制DS18B20完成一次温度转换.
    204           *
    205           * @param       none
    206           *
    207           * @return      测量的温度数值, 后4位是小数, 前面的5位空, 中间的7位是整数部分.
    208           *              返回0表示出错, 这个根据实际情况可以修改合适的数值.
    209           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    210          uint16 DS18B20_ConvertTemp(void)
   \                     DS18B20_ConvertTemp:
    211          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
    212              uint8 timeCnt; 
    213          
    214              // 初始化设备
    215              if (0 == DS18B20_Init())
   \   000005                ; Setup parameters for call to function DS18B20_Init
   \   000005   12....       LCALL   ??DS18B20_Init?relay
   \   000008   E9           MOV     A,R1
   \   000009   7006         JNZ     ??DS18B20_ConvertTemp_0
    216              {
    217                  return(0);  // 初始化失败
   \                     ??DS18B20_ConvertTemp_1:
   \   00000B   7A00         MOV     R2,#0x0
   \   00000D   7B00         MOV     R3,#0x0
   \   00000F   802A         SJMP    ??DS18B20_ConvertTemp_2
    218              }
    219              
    220              DS18B20_WriteCMD(SKIP_ROM_CMD);         // 跳过ROM命令
   \                     ??DS18B20_ConvertTemp_0:
   \   000011                ; Setup parameters for call to function DS18B20_WriteCMD
   \   000011   79CC         MOV     R1,#-0x34
   \   000013   12....       LCALL   ??DS18B20_WriteCMD?relay
    221              DS18B20_WriteCMD(CONVERT_T_CMD);        // 温度转换命令
   \   000016                ; Setup parameters for call to function DS18B20_WriteCMD
   \   000016   7944         MOV     R1,#0x44
   \   000018   12....       LCALL   ??DS18B20_WriteCMD?relay
    222              // 延时800ms以上, 确保转换完成
    223              for (timeCnt=0; timeCnt<80; timeCnt++)  
   \   00001B   7E50         MOV     R6,#0x50
    224              {
    225                  HalDs18b20DelayNus(10000);          //  延时10ms
   \                     ??DS18B20_ConvertTemp_3:
   \   00001D                ; Setup parameters for call to function HalDs18b20DelayNus
   \   00001D   7A10         MOV     R2,#0x10
   \   00001F   7B27         MOV     R3,#0x27
   \   000021   12....       LCALL   ??HalDs18b20DelayNus?relay
    226              }
   \   000024   1E           DEC     R6
   \   000025   EE           MOV     A,R6
   \   000026   70F5         JNZ     ??DS18B20_ConvertTemp_3
    227              
    228              // 再次复位设备
    229              if (0 == DS18B20_Init())
   \   000028                ; Setup parameters for call to function DS18B20_Init
   \   000028   12....       LCALL   ??DS18B20_Init?relay
   \   00002B   E9           MOV     A,R1
   \   00002C   60DD         JZ      ??DS18B20_ConvertTemp_1
    230              {
    231                  return(0);  // 初始化失败
    232              }
    233              
    234              DS18B20_WriteCMD(SKIP_ROM_CMD);         // 跳过ROM命令
   \   00002E                ; Setup parameters for call to function DS18B20_WriteCMD
   \   00002E   79CC         MOV     R1,#-0x34
   \   000030   12....       LCALL   ??DS18B20_WriteCMD?relay
    235              DS18B20_WriteCMD(READ_SCRATCHPAD_CMD);  // 读取转换结果
   \   000033                ; Setup parameters for call to function DS18B20_WriteCMD
   \   000033   79BE         MOV     R1,#-0x42
   \   000035   12....       LCALL   ??DS18B20_WriteCMD?relay
    236              return(DS18B20_ReadTemp());             // 返回温度值
   \   000038                ; Setup parameters for call to function DS18B20_ReadTemp
   \   000038   12....       LCALL   ??DS18B20_ReadTemp?relay
   \                     ??DS18B20_ConvertTemp_2:
   \   00003B   02....       LJMP    ??Subroutine3_0 & 0xFFFF
    237          }

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??HalDs18b20DelayNus?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    HalDs18b20DelayNus

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??DS18B20_Init?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    DS18B20_Init

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??DS18B20_WriteCMD?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    DS18B20_WriteCMD

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??DS18B20_ReadByte?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    DS18B20_ReadByte

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??DS18B20_ReadTemp?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    DS18B20_ReadTemp

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??DS18B20_ConvertTemp?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    DS18B20_ConvertTemp

   Maximum stack usage in bytes:

     Function                ISTACK PSTACK XSTACK
     --------                ------ ------ ------
     DS18B20_ConvertTemp         0      0      9
       -> DS18B20_Init           0      0     18
       -> DS18B20_WriteCMD       0      0     18
       -> DS18B20_WriteCMD       0      0     18
       -> HalDs18b20DelayNus     0      0     18
       -> DS18B20_Init           0      0     18
       -> DS18B20_WriteCMD       0      0     18
       -> DS18B20_WriteCMD       0      0     18
       -> DS18B20_ReadTemp       0      0     18
     DS18B20_Init                0      0     18
       -> HalDs18b20DelayNus     0      0     18
       -> HalDs18b20DelayNus     0      0     18
       -> HalDs18b20DelayNus     0      0     18
     DS18B20_ReadByte            0      0     19
       -> HalDs18b20DelayNus     0      0     18
       -> HalDs18b20DelayNus     0      0     18
       -> HalDs18b20DelayNus     0      0     18
       -> HalDs18b20DelayNus     0      0     18
     DS18B20_ReadTemp            0      0     19
       -> DS18B20_ReadByte       0      0     20
       -> DS18B20_ReadByte       0      0     20
     DS18B20_WriteCMD            0      0     18
       -> HalDs18b20DelayNus     0      0     18
       -> HalDs18b20DelayNus     0      0     18
       -> HalDs18b20DelayNus     0      0     18
     HalDs18b20DelayNus          0      0      9


   Segment part sizes:

     Function/Label              Bytes
     --------------              -----
     _A_P1                          1
     _A_IEN0                        1
     P1DIR                          1
     HalDs18b20DelayNus            24
     DS18B20_Init                  57
     ?Subroutine0                   1
     ??Subroutine3_0                5
     ?Subroutine2                   9
     DS18B20_WriteCMD              58
     ?Subroutine1                  14
     DS18B20_ReadByte              69
     DS18B20_ReadTemp              23
     DS18B20_ConvertTemp           62
     ??HalDs18b20DelayNus?relay     6
     ??DS18B20_Init?relay           6
     ??DS18B20_WriteCMD?relay       6
     ??DS18B20_ReadByte?relay       6
     ??DS18B20_ReadTemp?relay       6
     ??DS18B20_ConvertTemp?relay    6

 
 322 bytes in segment BANKED_CODE
  36 bytes in segment BANK_RELAYS
   3 bytes in segment SFR_AN
 
 358 bytes of CODE memory
   0 bytes of DATA memory (+ 3 bytes shared)

Errors: none
Warnings: none
